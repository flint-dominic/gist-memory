#!/bin/bash
# Gist Memory CLI wrapper
# Usage: gist recall "query"
#        gist remember "content" -t "title"
#        gist search "query"
#        gist stats

cd ~/clawd/gist-memory
source ~/clawd/.venv/bin/activate

case "$1" in
    recall|r)
        shift
        python src/recall.py "$@"
        ;;
    remember|rem)
        shift
        python src/remember.py "$@"
        ;;
    search|s)
        shift
        python src/retrieval.py search "$@"
        ;;
    encode|e)
        shift
        python src/encode.py "$@"
        ;;
    index|i)
        python src/retrieval.py index "$@"
        ;;
    stats|st)
        python src/retrieval.py stats
        ;;
    list|ls)
        shift
        python -c "
import sys
sys.path.insert(0, 'src')
from reinforcement import get_tracker, load_memory_yaml
import yaml
from pathlib import Path

tracker = get_tracker()
examples = sorted(Path('examples').glob('*.yaml'))

show_all = '--all' in sys.argv or '-a' in sys.argv

print('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—')
print('â•‘  GIST MEMORY INDEX                                                 â•‘')
print('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£')

for f in examples:
    try:
        mem = yaml.safe_load(f.read_text())
        mem_id = mem.get('id', f.stem)
        frames = mem.get('gist', {}).get('frames', [])[:3]
        salience = tracker.calculate_salience(mem_id)
        accesses = tracker.get(mem_id).access_count
        immune = 'ğŸ”’' if tracker.get(mem_id).decay_immune else '  '
        
        frame_str = ', '.join(frames)[:30]
        print(f'â•‘ {immune} {salience:.2f} [{accesses:2d}] {mem_id[:28]:<28} â”‚ {frame_str}')
    except:
        pass

print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')
print(f'   Total: {len(examples)} memories')
" "$@"
        ;;
    context|c)
        shift
        python src/context.py "$@"
        ;;
    inspect|in)
        shift
        python src/reinforcement.py inspect "$@"
        ;;
    boost|b)
        shift
        python src/reinforcement.py boost "$@"
        ;;
    decay|d)
        shift
        python src/reinforcement.py decay "$@"
        ;;
    reinforce-stats|rs)
        python src/reinforcement.py stats
        ;;
    sleep|sl)
        python src/consolidate.py
        ;;
    bootstrap|boot)
        python src/session.py bootstrap
        ;;
    identity|id)
        python src/session.py identity
        ;;
    session-start)
        shift
        python src/session.py start "$@"
        ;;
    session-end)
        shift
        python src/session.py end "$@"
        ;;
    help|--help|-h)
        echo "Gist Memory CLI"
        echo ""
        echo "Commands:"
        echo "  recall <query>     Recall memories relevant to query"
        echo "  remember <text>    Encode and save new memory"
        echo "  search <query>     Raw semantic search"
        echo "  context <msg>      Auto-inject relevant context"
        echo "  encode <file>      Encode file to memory YAML"
        echo "  index              Re-index all memories"
        echo "  stats              Show memory stats"
        echo "  list               List all memories with salience"
        echo ""
        echo "Reinforcement:"
        echo "  inspect <id>       Show full memory stats + reinforcement"
        echo "  boost <id> [--lock]  Boost memory salience (--lock = decay immune)"
        echo "  decay [threshold]  Show memories fading below threshold (default 0.3)"
        echo "  reinforce-stats    Show reinforcement statistics"
        echo "  sleep              Consolidation analysis (what could be merged)"
        echo ""
        echo "Session Integration:"
        echo "  bootstrap          Load identity + context for session start"
        echo "  identity           List core identity memories"
        echo "  session-start      Log session start, get context"
        echo "  session-end        Get encoding prompt for session end"
        echo ""
        echo "Examples:"
        echo "  gist recall 'what is fuzzy trace theory'"
        echo "  gist context 'what was the memory architecture based on'"
        echo "  gist remember 'content' -t 'title'"
        echo "  gist inspect mem-001-founding"
        echo "  gist boost mem-005-llmoblings --lock"
        ;;
    *)
        echo "Unknown command: $1"
        echo "Run 'gist help' for usage"
        exit 1
        ;;
esac
