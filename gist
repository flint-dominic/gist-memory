#!/bin/bash
# Gist Memory CLI wrapper
# Usage: gist recall "query"
#        gist remember "content" -t "title"
#        gist search "query"
#        gist stats

cd ~/clawd/gist-memory
source ~/clawd/.venv/bin/activate

case "$1" in
    recall|r)
        shift
        python src/recall.py "$@"
        ;;
    remember|rem)
        shift
        python src/remember.py "$@"
        ;;
    search|s)
        shift
        python src/retrieval.py search "$@"
        ;;
    encode|e)
        shift
        python src/encode.py "$@"
        ;;
    index|i)
        python src/retrieval.py index "$@"
        ;;
    stats|st)
        python src/retrieval.py stats
        ;;
    list|ls)
        shift
        python -c "
import sys
sys.path.insert(0, 'src')
from reinforcement import get_tracker, load_memory_yaml
import yaml
from pathlib import Path

tracker = get_tracker()
examples = sorted(Path('examples').glob('*.yaml'))

show_all = '--all' in sys.argv or '-a' in sys.argv

print('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—')
print('â•‘  GIST MEMORY INDEX                                                 â•‘')
print('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£')

for f in examples:
    try:
        mem = yaml.safe_load(f.read_text())
        mem_id = mem.get('id', f.stem)
        frames = mem.get('gist', {}).get('frames', [])[:3]
        salience = tracker.calculate_salience(mem_id)
        accesses = tracker.get(mem_id).access_count
        immune = 'ğŸ”’' if tracker.get(mem_id).decay_immune else '  '
        
        frame_str = ', '.join(frames)[:30]
        print(f'â•‘ {immune} {salience:.2f} [{accesses:2d}] {mem_id[:28]:<28} â”‚ {frame_str}')
    except:
        pass

print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')
print(f'   Total: {len(examples)} memories')
" "$@"
        ;;
    context|c)
        shift
        python src/context.py "$@"
        ;;
    inspect|in)
        shift
        python src/reinforcement.py inspect "$@"
        ;;
    boost|b)
        shift
        python src/reinforcement.py boost "$@"
        ;;
    decay|d)
        shift
        python src/reinforcement.py decay "$@"
        ;;
    reinforce-stats|rs)
        python src/reinforcement.py stats
        ;;
    sleep|sl)
        python src/consolidate.py
        ;;
    # === Storage Tiers ===
    tiers|t)
        python src/storage.py report
        ;;
    tier)
        shift
        python src/storage.py tier "$@"
        ;;
    tier-update|tu)
        python src/storage.py update
        ;;
    lock)
        shift
        python src/storage.py lock "$@"
        ;;
    unlock)
        shift
        python src/storage.py unlock "$@"
        ;;
    archive)
        shift
        python src/storage.py archive "$@"
        ;;
    # === Memory Links ===
    links)
        shift
        if [ -z "$1" ]; then
            python src/links.py graph
        else
            python src/links.py show "$@"
        fi
        ;;
    link)
        shift
        python src/links.py link "$@"
        ;;
    unlink)
        shift
        python src/links.py unlink "$@"
        ;;
    path)
        shift
        python src/links.py path "$@"
        ;;
    suggest)
        shift
        python src/links.py suggest "$@"
        ;;
    # === Multi-Perspective Frames ===
    perspectives|persp|p)
        shift
        if [ -z "$1" ]; then
            python src/perspectives.py show
        else
            python src/perspectives.py show "$1"
        fi
        ;;
    perspective-add|pa)
        shift
        python src/perspectives.py add "$@"
        ;;
    perspective-gen|pg)
        shift
        python src/perspectives.py generate "$@"
        ;;
    perspective-batch|pb)
        shift
        python src/perspectives.py batch "$@"
        ;;
    perspective-context|pc)
        shift
        python src/perspectives.py context "$@"
        ;;
    bootstrap|boot)
        python src/session.py bootstrap
        ;;
    identity|id)
        python src/session.py identity
        ;;
    session-start)
        shift
        python src/session.py start "$@"
        ;;
    session-end)
        shift
        python src/session.py end "$@"
        ;;
    auto-encode|ae)
        shift
        python src/session.py auto-encode "$@"
        ;;
    unified|u)
        shift
        python src/recall.py --hybrid "$@"
        ;;
    corpus)
        shift
        python src/markdown_index.py "$@"
        ;;
    inject)
        shift
        python src/inject.py "$@"
        ;;
    help|--help|-h)
        echo "Gist Memory CLI"
        echo ""
        echo "Commands:"
        echo "  recall <query>     Recall memories relevant to query"
        echo "  remember <text>    Encode and save new memory"
        echo "  search <query>     Raw semantic search"
        echo "  context <msg>      Auto-inject relevant context"
        echo "  encode <file>      Encode file to memory YAML"
        echo "  index              Re-index all memories"
        echo "  stats              Show memory stats"
        echo "  list               List all memories with salience"
        echo ""
        echo "Reinforcement:"
        echo "  inspect <id>       Show full memory stats + reinforcement"
        echo "  boost <id> [--lock]  Boost memory salience (--lock = decay immune)"
        echo "  decay [threshold]  Show memories fading below threshold (default 0.3)"
        echo "  reinforce-stats    Show reinforcement statistics"
        echo "  sleep              Consolidation analysis (what could be merged)"
        echo ""
        echo "Storage Tiers (ğŸ”¥ hot â†’ â˜€ï¸ warm â†’ â„ï¸ cold):"
        echo "  tiers              Show memory tier report"
        echo "  tier <id>          Show tier status for a memory"
        echo "  tier-update        Update all memory tiers based on activity"
        echo "  lock <id>          Lock memory (won't decay below warm)"
        echo "  unlock <id>        Unlock memory"
        echo "  archive <id>       Archive cold memory's verbatim"
        echo ""
        echo "Memory Links (ğŸ”— Zettelkasten-style):"
        echo "  links [id]         Show link graph (or links for specific memory)"
        echo "  link <src> <tgt> <type> [note]  Create link between memories"
        echo "  unlink <src> <tgt> Remove link"
        echo "  path <from> <to>   Find path between memories"
        echo "  suggest <id>       Suggest potential links"
        echo "  Link types: elaborates, contradicts, supersedes, relates_to, caused_by, leads_to"
        echo ""
        echo "Multi-Perspective Frames (ğŸ­ Thousand Brains-inspired):"
        echo "  perspectives [id]  Show all perspectives (or for specific memory)"
        echo "  perspective-add <id> -f <frame> -g <gist> [-s <salience>]"
        echo "  perspective-gen <id>  Generate perspectives via LLM"
        echo "  perspective-batch     Generate for all memories without perspectives"
        echo "  perspective-context <id> -c <frame1> <frame2>  Get best for context"
        echo ""
        echo "Session Integration:"
        echo "  bootstrap          Load identity + context for session start"
        echo "  identity           List core identity memories"
        echo "  session-start      Log session start, get context"
        echo "  session-end        Get encoding prompt for session end"
        echo "  auto-encode        Fully automatic memory encoding"
        echo "                     gist auto-encode 'content' -t 'title'"
        echo "                     gist auto-encode -f session.txt"
        echo "                     cat transcript | gist auto-encode"
        echo "  unified <query>    Search BOTH gist + markdown memories (hybrid)"
        echo "  corpus index       Index markdown files (memory/, docs/, MEMORY.md)"
        echo "  corpus search <q>  Search markdown corpus only"
        echo "  corpus status      Show corpus index stats"
        echo "  corpus reset       Clear corpus index"
        echo ""
        echo "Examples:"
        echo "  gist recall 'what is fuzzy trace theory'"
        echo "  gist remember 'content' -t 'title'"
        echo "  gist tiers                           # See storage tiers"
        echo "  gist link mem-001 mem-003 elaborates 'More detail on this'"
        echo "  gist boost mem-005-llmoblings --lock"
        ;;
    *)
        echo "Unknown command: $1"
        echo "Run 'gist help' for usage"
        exit 1
        ;;
esac
